
# Задание
Вам нужно спроектировать безопасную архитектуру системы, включающую механизмы аутентификации, авторизации, защиты данных при передаче, а также управление секретами. Задача направлена на интеграцию изученных технологий для создания надёжного и масштабируемого решения, устойчивого к внешним и внутренним угрозам.

# Архитектура системы


# 1. Аутентификация и авторизация

Выбираем механизм OAuth2.0, OIDC, JWT.
Как будут выдаваться и проверяться токены доступа.
Флоу №1. Пользователь редиректится на страницу Keycloak где он вводит логин/пароль. В этот момент Keycloak через LDAP identity provider проверят валидность кредов, и если все ок то на фронт отдаётся auth_code и ID_token. С этого момента мы считаем пользователя аутентифицированным. Затем фронт обменивает auth_code на access_token, это делается отдельным запросом к keycloak. Теперь у пользователя через фронтальное приложение есть право пользоваться нашим бэкэндом. Access_token будет проверяться на уровне API Gateway и в некоторых случаях на конечном бэкэнд сервисе.
Флоу №2. В случае если пользователь решил залогиниться через стороннего IdP, например через Google, auth flow немного изменится. Итак, разлогиненный пользователь попадает на экран логина и нажимает "войти с использованием Google". Он попадает на экран гугла ввода логина/пароля. После успешного ввода credentials, гугл спрашивает разрешение у пользователя доверять приложению и какие данные можно ему передать. Пользователь выбирает. И далее гугл редиректит фронтальное приложение обратно на Keycloak и присоединяет к запросу ID-token, в виде JWT в payload которого указаны основные данные о пользователе: email, sub, фио, и пр. Keycloak, получив данный id-token, который подписан сертом гугл, считает с этого момента что пользователь успешно аутентифицировался, и передает на фронт Id token и свой auth_code. Фронт делает запрос на эндпоинт получения токенов, далее бэкэнд этого эндпоинта меняет auth_code на AT, возвращает на фронт AT и одновременно кладет AT в Redis кэш. Теперь фронт, имея AT, может осуществлять авторизованные вызовы бэкэнда. В нашем случает AT будет в виде строки (не JWT), для проверки токена обязателен вызов Keycloak.
Флоу №3. Сценарии экспирации и обновления токенов. Фронт следит за временем истечения access token (ат). За 3 минуты (параметр конфигурируемый) до истечения ат, фронт вызывает на бэкэнде эндпоинт обновления токена. На вход в эндпоинт, фронт передает текущий ат. Далее бэкэнд достает из защищенного хранилища refresh token (рт) и идёт в Keycloak с парой ат+рт. Бэкэнд получает от Keycloak новую пару ат и рефреш токена (рт), возвращает на фронт ат и обновляет ат в Redis кэш. Фронт сохранят токен в local storage и продолжает работать с приложением.
Фронтальное приложение делает повторный



